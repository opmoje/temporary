<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>M4S</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=36f36819-8f02-439f-bf00-f9676151c068&lang=ru_RU&load=package.full"
            type="text/javascript"></script>
    <script
            src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
            font-family: Tahoma, serif;
            font-size: 14px;
        }

        #wrap {
            position: relative;
        }

        #toolbar {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 999;
            box-sizing: border-box;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 15px;
            width: 400px;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .ymap-container {
            height: 100%;
        }

        .points {
            margin-top: 15px;
        }

        .points .point {
            font-size: 13px;
            display: flex;
        }
    </style>
</head>
<body>
<div id="wrap">
    <div id="toolbar">
        <div>
            <div>
                Термические точки в области видимости:
            </div>
            <div id="pointsList" class="points"></div>
        </div>
    </div>
    <div id="map"></div>
</div>

<script type="text/javascript">
    var myMap;
    var objectManager;

    ymaps.ready().then(function () {
        myMap = new ymaps.Map("map", {
            center: [56.7428, 80.4355],
            zoom: 4,
            type: 'yandex#satellite',
            controls: ['zoomControl']
        });

        var clusterIcons = [
            {
                href: 'assets/icons/c5.png',
                size: [40, 40],
                // Отступ, чтобы центр картинки совпадал с центром кластера.
                offset: [-20, -20]
            },
            {
                href: 'assets/icons/c5.png',
                size: [55, 55],
                offset: [-22.5, -22.5]
            },
            {
                href: 'assets/icons/c5.png',
                size: [65, 65],
                offset: [-32.5, -32.5]
            },
            {
                href: 'assets/icons/c5.png',
                size: [70, 70],
                offset: [-35, -35]
            },
            {
                href: 'assets/icons/c5.png',
                size: [75, 75],
                offset: [-37.5, -37.5]
            }
        ];

        objectManager = new ymaps.ObjectManager({
            clusterize: true,
            //gridSize: 30,
            //geoObjectOpenBalloonOnClick: true,
            //clusterHasHint: true,
            //clusterBalloonContentLayout: "cluster#balloonCarousel",
            //balloonContentLayoutHeight: 140,
            //balloonContentLayoutWidth: 240,
            clusterIcons: clusterIcons,
            //clusterIconContentLayout: null
        });

        //objectManager.objects.options.set('preset', 'islands#grayIcon');

        var jsonUrl = '/data-points.json';

        $.getJSON(jsonUrl, function (jsonArr) {
            if (!jsonArr.length) {
                return;
            }

            var myGeoObjects = [],
                currentId = 0;

            for (var k in jsonArr) {
                if (!jsonArr[k].hasOwnProperty('ya')
                    || !jsonArr[k].hasOwnProperty('yi')
                    || !jsonArr[k].hasOwnProperty('xa')
                    || !jsonArr[k].hasOwnProperty('xi')
                    || !jsonArr[k].hasOwnProperty('fire_status')
                    || !jsonArr[k].hasOwnProperty('land_category')
                ) {
                    return;
                }

                var item = jsonArr[k];

                var centerOfLat = (item.ya + item.yi) / 2,
                    centerOfLon = (item.xa + item.xi) / 2;

                var iconName = item.fire_status === 'BRN' ? 'c5.png' : 'loc.png';

                myGeoObjects.push({
                    type: 'Feature',
                    id: currentId++,
                    geometry: {
                        type: 'Point',
                        coordinates: [
                            centerOfLat,
                            centerOfLon
                        ],
                    },
                    options: {
                        iconLayout: 'default#image',
                        iconImageHref: 'assets/icons/' + iconName,
                        iconImageSize: [22, 22],
                        iconImageOffset: [-11, -11],
                        custom: {
                            fire_status: item.fire_status,
                            land_category: item.land_category,
                        }
                    }
                });
            }

            // точки в менеджер объектов для отрисовки
            objectManager.add(myGeoObjects);

            //objectManager.add(myGeoObjects);
            myMap.geoObjects.add(objectManager);

            myMap.container.fitToViewport();
            myMap.setBounds(myMap.geoObjects.getBounds(), {
                checkZoomRange: true
            });
        })


        myMap.events.add('click', function (e) {
            var coords = e.get('coords');
            console.log(coords[0].toPrecision(6), coords[1].toPrecision(6))
        });

        myMap.events.add('boundschange', function () {
            // После каждого сдвига карты будем смотреть, какие объекты попадают в видимую область.
            refreshVisibleList();
        });

        // сразу смотрим, какие объекты попадают на карту
        refreshVisibleList();
    });

    function refreshVisibleList() {
        setTimeout(function () {
            var objects = objectManager.objects.getAll(),
                visibleObjectsHtml = [];

            objects.forEach(function (object) {
                // Получим данные о состоянии объекта внутри кластера.
                var objectState = objectManager.getObjectState(object.id);

                // Проверяем, находится ли объект в видимой области карты.
                if (objectState.found && objectState.isShown) {

                    if (objectState.isClustered) {
                        visibleObjectsHtml.push(buildListItem(objectState.cluster.options.custom));
                        console.log(objectState.cluster);
                    } else {
                        // Если объект не попал в кластер, открываем его собственный балун.
                        visibleObjectsHtml.push(buildListItem(object.options.custom));
                        console.log(object);
                    }
                }
            });

            // Обновляем список.
            var visibleElement = document.getElementById('pointsList');
            visibleElement.innerHTML = visibleObjectsHtml.join('');
        }, 100)
    }

    function buildListItem(props) {
        var definition = landCategoryDefinition(props.land_category);

        return '<div class="point priority-' + definition.priority + '">' +
                '<div>Точка 1</div>' +
                '<div>' + definition.title + '</div>' +
                '<div>' + (props.fire_status === 'BRN' ? 'Горит' : 'Потушен') + '</div>' +
            '</div>';
    }

    /*function convertLandCategoryToHumanTitle(category) {
        if (category === '003001000000') return 'Земли сельскохозяйственного назначения';
        else if (category === '003002000000') return 'Земли населённых пунктов';
        else if (category === '003003000000') return 'Земли промышленности, энергетики, транспорта, связи, ' +
            'радиовещания, телевидения, информатики, земли для обеспечения космической деятельности, ' +
            'земли обороны, безопасности и земли иного специального назначения';
        else if (category === '003004000000') return 'Земли особо охраняемых территорий и объектов';
        else if (category === '003005000000') return 'Земли лесного фонда';
        else if (category === '003006000000') return 'Земли водного фонда';
        else if (category === '003007000000') return 'Земли запаса';
        else if (category === '003008000000') return 'Категория не установлена';
        else return 'Не определена';
    }*/

    function landCategoryDefinition(category) {
        let landCategoryTitle = 'Категория не установлена';
        let landCategoryPriority = 5;

        if (category === '003001000000') {
            landCategoryTitle = 'Земли сельскохозяйственного назначения';
            landCategoryPriority = 2;
        }
        if (category === '003002000000') {
            landCategoryTitle = 'Земли населённых пунктов';
            landCategoryPriority = 1;
        } else if (category === '003003000000') {
            landCategoryTitle = 'Земли промышленности, энергетики, транспорта, связи, ' +
                'радиовещания, телевидения, информатики, земли для обеспечения космической деятельности, ' +
                'земли обороны, безопасности и земли иного специального назначения';
            landCategoryPriority = 1;
        } else if (category === '003004000000') {
            landCategoryTitle = 'Земли особо охраняемых территорий и объектов';
            landCategoryPriority = 1;
        } else if (category === '003005000000') {
            landCategoryTitle = 'Земли лесного фонда';
            landCategoryPriority = 3;
        } else if (category === '003006000000') {
            landCategoryTitle = 'Земли водного фонда';
            landCategoryPriority = 4;
        } else if (category === '003007000000') {
            landCategoryTitle = 'Земли запаса';
            landCategoryPriority = 4;
        } else if (category === '003008000000') {
            landCategoryTitle = 'Категория не установлена';
            landCategoryPriority = 5;
        }

        return {
            'title': landCategoryTitle,
            'priority': landCategoryPriority,
        }
    }
</script>

</body>
</html>
